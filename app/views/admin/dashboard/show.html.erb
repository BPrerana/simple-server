<div class="sub-nav">
    <a href="#" class="sub-nav-link sub-nav-link-active">Last 90 days</a>
    <a href="#" class="sub-nav-link">Q3 2018</a>
    <a href="#" class="sub-nav-link">Q2 2018</a>
    <a href="#" class="sub-nav-link">Q1 2018</a>
    <a href="#" class="sub-nav-link">&#8226;&#8226;&#8226;</a>
</div>

<div class="dashboard">
    
    <h1>Brooklyn &amp; Queens</h1>
    <p class="dashboard-description">#2 of 19 reporting districts in New York State. State BP control average is 25% from reporting facilities.</p>
    
    <div class="featured">
        <table class="featured-table">
        <tr>
        <td class="featured-td">
            <div class="featured-section">
                <strong class="featured-title" style="color: #B81631;">BP control</strong>
                <span class="featured-number text-red">30%</span>
                <span class="featured-label">Goal: 45%</span>

                <div class="featured-graph">
                    <table>
                        <tr>
                            <td>
                                <div class="featured-graph-column" style="height: 25px; margin-top: 25px;">25%</div>
                                <span class="featured-month">Sep</span>
                            </td>
                            <td>
                                <div class="featured-graph-column" style="height: 26px; margin-top: 24px;">26%</div>
                                <span class="featured-month">Oct</span>
                            </td>
                            <td>
                                <div class="featured-graph-column" style="height: 28px; margin-top: 22px;">28%</div>
                                <span class="featured-month">Nov</span>
                            </td>
                            <td>
                                <div class="featured-graph-column" style="height: 30px; margin-top: 20px;">30%</div>
                                <span class="featured-month">Dec</span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <!--div class="featured-footer">
                <strong>Ranked 2nd of 9</strong>
                <span>districts in state</span>
            </div-->
        </td>
        <td class="featured-middle featured-td">
            <div class="featured-section">
                <strong class="featured-title" style="color: #007A31;">Enrolled</strong>
                <span class="featured-number text-green">+1,345</span>
                <span class="featured-label">New patients</span>
                
                <strong class="featured-title" style="color: #007A31;">Follow-ups</strong>
                <span class="featured-number  text-green">12,456</span>
                <span class="featured-label">Returning patients</span>
            </div>
            <!--div class="featured-footer">
                <strong>24,342 patients</strong>
                <span>enrolled all time</span>
            </div-->
        </td>
        <td class="featured-td">
            <div class="featured-section">
                <strong class="featured-title" style="color: #E0B000;">Didn't attend</strong>
                <span class="featured-number text-yellow">10,321</span>
                <span class="featured-label">Expected patients</span>

                <div class="featured-graph">
                    <table>
                        <tr>
                            <td>
                                <div class="featured-graph-column featured-graph-column-yellow" style="height: 27.5px; margin-top: 22.5px;">55%</div>
                                <span class="featured-month">Sep</span>
                            </td>
                            <td>
                                <div class="featured-graph-column featured-graph-column-yellow" style="height: 32.5px; margin-top: 17.5px;">65%</div>
                                <span class="featured-month">Oct</span>
                            </td>
                            <td>
                                <div class="featured-graph-column featured-graph-column-yellow" style="height: 25.5px; margin-top: 24.5px;">51%</div>
                                <span class="featured-month">Nov</span></td>
                            <td>
                                <div class="featured-graph-column featured-graph-column-yellow" style="height: 21px; margin-top: 29px;">42%</div>
                                <span class="featured-month">Dec</span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <!--div class="featured-footer">
                <strong>45 call attempts</strong>
                <span>via Simple app</span>
            </div-->
        </td>
        </tr>
        </table>
        
    </div>
</div>


<section class="table-compact">

<div class="table-responsive">
  <table>
    <thead>
        <tr>
            <th colspan="2"><h4>Hospitals &amp; Clinics</h4></th>
            <th class="row-label">BP control</th>
            <th class="row-label">Enrolled</th>
            <th class="row-label">Didn't attend</th>
            <th class="row-label">Calls made</th>
            <th class="row-label">Unique patients</th>
            
            <th class="row-label row-month"><div>Week of</div>Sep 23</th>
            <th class="row-label"><div>Week of</div>Sep 30</th>
            <th class="row-label"><div>Week of</div>Oct 7</th>
            <th class="row-label"><div>Week of</div>Oct 14</th>
            
            <th class="row-label row-month"><div>Week of</div>Oct 21</th>
            <th class="row-label"><div>Week of</div>Oct 28</th>
            <th class="row-label"><div>Week of</div>Nov 4</th>
            <th class="row-label"><div>Week of</div>Nov 11</th>
            
            <th class="row-label row-month"><div>Week of</div>Nov 18</th>
            <th class="row-label"><div>Week of</div>Nov 25</th>
            <th class="row-label"><div>Week of</div>Dec 2</th>
            <th class="row-label">This<br>week</th>
            
            <th>&nbsp;</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="row-rank">1</td>
            <td class="row-title"><a href="#">CHC Brooklyn Bridge</a><span><b>4567</b> enrolled all time</span></td>
            <td class="row-control text-red">65%</td>
            <td class="row-enrolled text-green">+98</td>
            <td class="row-default text-yellow">1321</td>
            <td class="row-calls text-yellow">5</td>
            <td class="row-unique">241</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">2</td>
            <td class="row-title"><a href="#">PHC Coney</a><span><b>165</b> enrolled all time</span></td>
            <td class="row-control text-red">58%</td>
            <td class="row-enrolled text-green">+37</td>
            <td class="row-default text-yellow">43</td>
            <td class="row-calls text-yellow">2</td>
            <td class="row-unique">121</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">3</td>
            <td class="row-title"><a href="#">CHC Prospect Heights</a><span><b>890</b> enrolled all time</span></td>
            <td class="row-control text-red">52%</td>
            <td class="row-enrolled text-green">+16</td>
            <td class="row-default text-yellow">140</td>
            <td class="row-calls text-yellow"><span class="null">0</span></td>
            <td class="row-unique">423</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">4</td>
            <td class="row-title"><a href="#">District Hospital Brooklyn Downtown</a><span><b>5723</b> enrolled all time</span></td>
            <td class="row-control text-red">50%</td>
            <td class="row-enrolled text-green">+321</td>
            <td class="row-default text-yellow">1234</td>
            <td class="row-calls text-yellow"><span class="null">0</span></td>
            <td class="row-unique">1232</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">5</td>
            <td class="row-title"><a href="#">PHC Bedford-Stuyvesant</a><span><b>4567</b> enrolled all time</span></td>
            <td class="row-control text-red">65%</td>
            <td class="row-enrolled text-green">+98</td>
            <td class="row-default text-yellow">1321</td>
            <td class="row-calls text-yellow"><span class="null">0</span></td>
            <td class="row-unique">241</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">6</td>
            <td class="row-title"><a href="#">PHC Hoyt</a><span><b>165</b> enrolled all time</span></td>
            <td class="row-control text-red">58%</td>
            <td class="row-enrolled text-green">+37</td>
            <td class="row-default text-yellow">43</td>
            <td class="row-calls text-yellow">2</td>
            <td class="row-unique">121</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">7</td>
            <td class="row-title"><a href="#">CHC Marine Park</a><span><b>890</b> enrolled all time</span></td>
            <td class="row-control text-red">52%</td>
            <td class="row-enrolled text-green">+16</td>
            <td class="row-default text-yellow">140</td>
            <td class="row-calls text-yellow">14</td>
            <td class="row-unique">423</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="row-rank">8</td>
            <td class="row-title"><a href="#">SDH Long Island City</a><span><b>5723</b> enrolled all time</span></td>
            <td class="row-control text-red">50%</td>
            <td class="row-enrolled text-green">+321</td>
            <td class="row-default text-yellow">1234</td>
            <td class="row-calls text-yellow"><span class="null">0</span></td>
            <td class="row-unique">1232</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
    </tbody>
    <tfoot>
        <tr class="row-total">
            <td class="row-rank row-total"></td>
            <td class="row-title row-total">All facility totals<span><b>24,342</b> enrolled all time</span></td>
            <td class="row-control text-red row-total">30%</td>
            <td class="row-enrolled text-green row-total">+1,345</td>
            <td class="row-default text-yellow row-total">10,321</td>
            <td class="row-calls text-yellow">124</td>
            <td class="row-unique row-total">13,801</td>
            
            <td class="row-unique-date row-month"><span class="null">0</span></td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">11</td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date">19</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date"><span class="null">0</span></td>
            
            <td class="row-unique-date row-month">12</td>
            <td class="row-unique-date"><span class="null">0</span></td>
            <td class="row-unique-date">21</td>
            <td class="row-unique-date">11</td>
            
            <td>&nbsp;</td>
        </tr>
    </tfoot>
  </table>
</div>
</section>

<section>
    <h4>Notes</h4>
    <p class="footnote"><strong>BP control</strong> is calculated as a rolling cohort. A patient who was seen > 3 months ago is controlled if their BP in the last 3 months has SBP ≤ 140 or DBP ≤ 90.</p>
    <p class="footnote"><strong>Didn't attend</strong> patients had a BP > 140/90 have not had a BP recorded in the past 3 months.</p>
    <p class="footnote"><strong>Top performers:</strong> > 100 enrolled patients and highest BP control.</p>
</section>


<div style="padding: 400px 0; color: #eee;">TEMP</div>

<% if policy(User).enable_access? && @users_requesting_approval.any? %>
  <h3><%= pluralize(@users_requesting_approval.count || 0, "user") %> waiting for access</h3>

  <% @users_requesting_approval.each do |user| %>
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-lg-3">

              <strong><%= link_to user.full_name, [:admin, user] %></strong>
              (<small><%= user.sync_approval_status_reason %></small>)

          </div>
          <div class="col">
            <div class="row tight">
              <div class="col">

                <small>Ph: <a href="tel:<%= user.phone_number %>"><%= user.phone_number %></a></small>
              </div>
              <div class="col tight">
                <small>
                <%= user.registered_at_facility.present? ? link_to(user.registered_at_facility.name, [:admin, user.registered_at_facility]) : "N/A" %>
                </small>
              </div>
            </div>
          </div>
          <div class="col-lg-4 text-lg-right">
            <%= link_to "Allow access", admin_user_enable_access_path(user), method: :put, class: "btn btn-sm btn-success", data: { confirm: I18n.t('admin.enable_access_alert') } %>
            <%= link_to 'Deny access', '#deny-access-modal-' + user.id, 'data-toggle' => 'modal', class: "btn btn-sm btn-outline-danger" %>

            <%= render partial: "admin/users/deny_access_modal", locals: { user: user } %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

<% end %>

<section>

<div class="table-responsive">
  <table class="table table-sm">
    <thead class="thead-light">
      <tr>

        <th><h3>Daily unique patients</h3></th>

        <th class="text-center">Total Patients</th>
        <% @days_previous.downto(0).map { |since| since.days.ago }.each do |day| %>
          <th class="text-center <%= "holiday" if day.sunday? %>">
            <small><strong><%= day.strftime("%b") %><br><%= day.strftime("%d") %></strong></small>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @facilities.sort_by(&:name).each do |facility| %>
        <% next if @visits_by_facility.fetch(facility.id, 0)  == 0 %>

        <tr class="table-info table-row-small">
          <td class="row-title"><strong><%= facility.name %></strong></td>
          <td class="text-center"><%= lighten_if_zero(@visits_by_facility[facility.id] || 0) %></td>
          <% @days_previous.downto(0).map { |since| since.days.ago }.each do |day| %>
            <td class="text-center <%= "holiday" if day.sunday? %>"></td>
          <% end %>
        </tr>

        <% facility.users.sort_by(&:full_name).each do |user| %>
          <tr class="table-row-small">
            <td class="pl-lg-4"><%= user.full_name %></td>
            <td class="text-center">
              <%= lighten_if_zero(@visits_by_facility_user[[facility.id, user.id]] || 0) %>
            </td>
            <% @days_previous.downto(0).map { |since| since.days.ago }.each do |day| %>
              <td class="text-center <%= "holiday" if day.sunday? %>">
                <%= lighten_if_zero(@visits_by_facility_user_day[[facility.id, user.id, day.in_time_zone("New Delhi").to_date]] || 0) %>
              </td>
            <% end %>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>
</section>

<section>

<div class="table-responsive">
  <table class="table table-sm">
    <thead class="thead-light">
      <tr>
        <th><h3>New patients registered</h3></th>
        <th class="text-center">Total</th>
        <% @months_previous.downto(0).each do |since| %>
          <th class="text-center">
            <%= since.months.ago.in_time_zone("New Delhi").strftime("%b") %><br>
            <%= since.months.ago.in_time_zone("New Delhi").strftime("%Y") %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @facilities.sort_by(&:name).each do |facility| %>
        <% next if @visits_by_facility.fetch(facility.id, 0) == 0 %>

        <tr class="table-light">

          <td class="row-title"><strong><%= facility.name %></strong></td>
          <td class="text-center"><%= lighten_if_zero(@new_patients_by_facility[facility.id] || 0) %></td>
          <% @months_previous.downto(0).each do |since| %>
            <td class="text-center">
              <%= lighten_if_zero(@new_patients_by_facility_month[[facility.id, since.months.ago.in_time_zone("New Delhi").beginning_of_month.to_date]] || 0) %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
</section>


<section>
<div class="table-responsive">
  <table class="table table-sm">
    <thead class="thead-light">
      <tr>
        <th><h3>Monthly unique patients</h3></th>
        <th class="text-center">&nbsp;&nbsp;&nbsp;</th> <!-- Spacer to match next table above -->
        <% @months_previous.downto(0).each do |since| %>
          <th class="text-center">
            <%= since.months.ago.in_time_zone("New Delhi").strftime("%b") %><br>
            <%= since.months.ago.in_time_zone("New Delhi").strftime("%Y") %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @facilities.sort_by(&:name).each do |facility| %>
        <% next if @visits_by_facility.fetch(facility.id, 0) == 0 %>

        <tr class="table-light">

          <td class="row-title"><strong><%= facility.name %></strong></td>
          <td>&nbsp;</td> <!-- Spacer to match next able above -->
          <% @months_previous.downto(0).each do |since| %>
            <td class="text-center">
              <%= lighten_if_zero(@visits_by_facility_month[[facility.id, since.months.ago.in_time_zone("New Delhi").beginning_of_month.to_date]] || 0) %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
</section>

<footer class="text-muted">
    <p><small>Note: All times are in India Standard Time</small></p>
</footer>
